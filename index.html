<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban PCM - Heineken</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sortable.js (Drag and Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- DOMPurify (Segurança) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <!-- Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sortable-ghost { opacity: 0.3; background: #dbeafe; border: 2px dashed #60a5fa; }
        .sortable-chosen { cursor: grabbing; opacity: 0.9; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .kanban-column-body { max-height: 75vh; overflow-y: auto; }
    </style>
</head>
<body class="antialiased text-gray-900">

<!-- Cabeçalho -->
<header class="bg-green-800 text-white shadow-lg sticky top-0 z-40">
    <div class="container mx-auto max-w-full px-4 md:px-8 py-4 flex justify-between items-center">
        <!-- Logo e Título -->
        <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12a7.5 7.5 0 0 0 15 0"/></svg>
            <div>
                <h1 class="text-2xl font-bold">Kanban PCM</h1>
                <p class="text-sm text-gray-200 font-light">Cervejaria Heineken</p>
            </div>
        </div>
        <!-- Botões de Ação -->
        <div class="flex items-center space-x-3">
            <div class="flex items-center space-x-2 mr-2">
                <label for="header-priority-select" class="text-sm font-medium sr-only">Prioridade Padrão</label>
                <select id="header-priority-select" class="px-3 py-2 rounded-lg bg-white text-gray-800 text-sm border border-green-600">
                    <option value="low">Baixa</option>
                    <option value="medium" selected>Média</option>
                    <option value="high">Alta</option>
                </select>
            </div>
            <button id="add-task-btn" class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded-lg font-semibold transition-colors">Adicionar OS</button>
            <button id="logout-btn" class="bg-green-500 text-white px-3 py-2 rounded-lg border border-green-600 text-sm font-medium hover:bg-red-600 hover:border-red-700 transition-colors">Sair</button>
        </div>
    </div>
</header>

<!-- Barra de Status da Autenticação -->
<div id="auth-status" class="py-2 px-6 bg-green-900 text-green-200 text-sm text-center sticky top-[80px] z-30">A conectar...</div>

<!-- Corpo Principal do Kanban -->
<main id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 p-6">
    
    <!-- Coluna 1: A RESTAURAR -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                <h3 class="font-semibold text-red-600 uppercase text-sm">A RESTAURAR</h3>
            </div>
            <span id="count-col-restaurar" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-restaurar" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-restaurar"></div>
    </div>

    <!-- Coluna 2: EM DIAGNÓSTICO -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                <h3 class="font-semibold text-yellow-600 uppercase text-sm">EM DIAGNÓSTICO</h3>
            </div>
            <span id="count-col-diagnostico" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-diagnostico" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-diagnostico"></div>
    </div>

    <!-- Coluna 3: EM RESTAURAÇÃO -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
                <h3 class="font-semibold text-orange-600 uppercase text-sm">EM RESTAURAÇÃO</h3>
            </div>
            <span id="count-col-restauracao" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-restauracao" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-restauracao"></div>
    </div>

    <!-- Coluna 4: EM TESTE / QUALIDADE -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                <h3 class="font-semibold text-blue-600 uppercase text-sm">EM TESTE / QUALIDADE</h3>
            </div>
            <span id="count-col-teste" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-teste" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-teste"></div>
    </div>

    <!-- Coluna 5: PRONTO PARA USO -->
    <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
            <div class="flex items-center space-x-3">
                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                <h3 class="font-semibold text-green-600 uppercase text-sm">PRONTO PARA USO</h3>
            </div>
            <span id="count-col-pronto" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
        </div>
        <div id="col-pronto" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-pronto"></div>
    </div>
</main>

<!-- Modal de Adicionar/Editar Tarefa -->
<div id="task-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full transform scale-95 opacity-0" id="task-modal-content">
        <form id="task-form">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h4 id="modal-title" class="text-2xl font-semibold text-gray-800">Adicionar Ordem de Serviço</h4>
                <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label for="task-id-input" class="block text-sm font-medium text-gray-700 mb-1">Nº da OS / SM (Obrigatório)</label>
                    <input type="text" id="task-id-input" placeholder="Ex: OS-45102" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <p id="task-id-display" class="text-lg font-medium text-gray-600 hidden"></p>
                </div>
                <div>
                    <label for="task-text-input" class="block text-sm font-medium text-gray-700 mb-1">Descrição do Serviço <span class="text-red-500">*</span></label>
                    <textarea id="task-text-input" rows="4" placeholder="Descreva o serviço..." class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></textarea>
                </div>
                <div>
                    <label for="task-priority-input" class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
                    <select id="task-priority-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="low">Baixa</option>
                        <option value="medium" selected>Média</option>
                        <option value="high">Alta</option>
                    </select>
                </div>
                <input type="hidden" id="task-id-hidden">
                <p id="modal-error-message" class="text-red-500 text-sm h-5"></p>
            </div>
            <div class="flex justify-end items-center space-x-4 p-5 bg-gray-50 rounded-b-lg">
                <button type="button" id="cancel-modal-btn" class="px-5 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="submit" id="save-task-btn" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">Salvar Ordem</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform scale-95 opacity-0" id="delete-modal-content">
        <h4 class="text-xl font-semibold mb-4">Confirmar Encerramento</h4>
        <p class="text-gray-600 mb-6">Tem certeza de que deseja encerrar esta OS?</p>
        <div class="flex justify-end space-x-3">
            <button id="cancel-delete-btn" class="px-5 py-2 rounded-lg bg-gray-300 hover:bg-gray-400 transition-colors">Cancelar</button>
            <button id="confirm-delete-btn" class="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">Encerrar OS</button>
        </div>
    </div>
</div>

<!-- 
    ! IMPORTANTE! 
    A CORREÇÃO ESTÁ AQUI: 
    Scripts alterados para '...-compat.js' para funcionar com a sintaxe v8.
-->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- 1. CONFIGURAÇÃO DO FIREBASE ---
    // ! COLE SUAS CHAVES DO FIREBASE AQUI!
    // (Vá em Configurações do Projeto > Seus Aplicativos > Web)
    const firebaseConfig = {
        apiKey: "...",
        authDomain: "...",
        projectId: "...",
        storageBucket: "...",
        messagingSenderId: "...",
        appId: "..."
    };

    // Inicializa o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 2. VARIÁVEIS GLOBAIS E ESTADO ---
    let currentUser = null;
    let userUid = null;
    let dbTasksRef = null; // Referência da coleção de tarefas
    let taskToDeleteId = null;
    let unsubscribeSnapshot = null; // Função para parar de ouvir o DB

    // --- 3. MAPEAMENTO DE ELEMENTOS DO DOM ---
    const authStatus = document.getElementById('auth-status');
    const logoutBtn = document.getElementById('logout-btn');
    const addTaskBtn = document.getElementById('add-task-btn');
    const headerPrioritySelect = document.getElementById('header-priority-select');

    const columns = {
        "col-restaurar": document.getElementById('col-restaurar'),
        "col-diagnostico": document.getElementById('col-diagnostico'),
        "col-restauracao": document.getElementById('col-restauracao'),
        "col-teste": document.getElementById('col-teste'),
        "col-pronto": document.getElementById('col-pronto')
    };
    const columnIds = Object.keys(columns);
    const columnCounts = {
        "col-restaurar": document.getElementById('count-col-restaurar'),
        "col-diagnostico": document.getElementById('count-col-diagnostico'),
        "col-restauracao": document.getElementById('count-col-restauracao'),
        "col-teste": document.getElementById('count-col-teste'),
        "col-pronto": document.getElementById('count-col-pronto')
    };

    // Modais
    const taskModal = document.getElementById('task-modal');
    const taskModalContent = document.getElementById('task-modal-content');
    const taskForm = document.getElementById('task-form');
    const modalTitle = document.getElementById('modal-title');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelModalBtn = document.getElementById('cancel-modal-btn');
    const saveTaskBtn = document.getElementById('save-task-btn');
    const taskIdInput = document.getElementById('task-id-input');
    const taskIdDisplay = document.getElementById('task-id-display');
    const taskTextInput = document.getElementById('task-text-input');
    const taskPriorityInput = document.getElementById('task-priority-input');
    const taskIdHidden = document.getElementById('task-id-hidden');
    const modalErrorMessage = document.getElementById('modal-error-message');
    
    const deleteModal = document.getElementById('delete-modal');
    const deleteModalContent = document.getElementById('delete-modal-content');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');


    // --- 4. LÓGICA DE AUTENTICAÇÃO ---

    auth.onAuthStateChanged(user => {
        if (user) {
            // Usuário está logado
            currentUser = user;
            userUid = user.uid;
            
            // Define a referência da coleção: /users/{userId}/tasks
            dbTasksRef = db.collection('users').doc(userUid).collection('tasks');
            
            const userName = user.email.split('@')[0];
            authStatus.textContent = `Conectado como: ${userName.charAt(0).toUpperCase() + userName.slice(1)}`;
            
            // Inicializa o quadro e o "ouvinte" do banco de dados
            initRealtimeListener();
            initSortable();

        } else {
            // Usuário não está logado
            currentUser = null;
            userUid = null;
            // Redireciona para a página de login
            window.location.replace('login.html');
        }
    });

    // Evento de Logout
    logoutBtn.addEventListener('click', () => {
        if (confirm('Deseja sair?')) {
            // Para de ouvir o banco de dados antes de sair
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
            }
            auth.signOut();
        }
    });

    // --- 5. LÓGICA DO BANCO DE DADOS (FIRESTORE) ---

    function initRealtimeListener() {
        if (!dbTasksRef) return;

        // Limpa o quadro (para o caso de troca de usuário, etc.)
        columnIds.forEach(id => columns[id].innerHTML = '');

        // O 'onSnapshot' é a mágica: ele é chamado 1 vez com todos os dados
        // e depois é chamado de novo *automaticamente* sempre que algo mudar no banco.
        unsubscribeSnapshot = dbTasksRef.onSnapshot(snapshot => {
            
            snapshot.docChanges().forEach(change => {
                const task = change.doc.data();
                const taskId = change.doc.id;
                
                const existingCard = document.querySelector(`[data-task-id="${taskId}"]`);

                if (change.type === 'added') {
                    // Novo card
                    if (existingCard) return; // Segurança contra duplicatas
                    const newCard = createTaskElement(task);
                    const colId = task.column || 'col-restaurar';
                    if (columns[colId]) {
                        columns[colId].appendChild(newCard);
                    }
                } 
                else if (change.type === 'modified') {
                    // Card editado (texto, prioridade ou coluna)
                    const updatedCard = createTaskElement(task);
                    const newColId = task.column || 'col-restaurar';

                    if (existingCard) {
                        // Se a coluna for diferente, move o card
                        if (existingCard.parentElement.dataset.columnId !== newColId) {
                            columns[newColId].appendChild(updatedCard);
                            existingCard.remove();
                        } else {
                            // Se for a mesma coluna, apenas substitui
                            existingCard.replaceWith(updatedCard);
                        }
                    } else if (columns[newColId]) {
                         columns[newColId].appendChild(updatedCard);
                    }
                } 
                else if (change.type === 'removed') {
                    // Card removido
                    if (existingCard) {
                        existingCard.remove();
                    }
                }
            });

            // Atualiza os contadores após qualquer mudança
            updateAllCounts();
        });
    }

    /**
     * Atualiza os contadores de todas as colunas.
     */
    function updateAllCounts() {
        columnIds.forEach(colId => {
            const count = columns[colId].childElementCount;
            columnCounts[colId].textContent = count;
        });
    }

    // --- 6. RENDERIZAÇÃO E MODAIS (Funções Auxiliares) ---
    
    function showModal(modal, content){ 
        modal.classList.remove('hidden'); 
        setTimeout(()=>{ 
            modal.classList.add('opacity-100'); 
            content.classList.add('scale-100','opacity-100'); 
            content.classList.remove('scale-95','opacity-0'); 
        }, 10);
    }

    function hideModal(modal, content){ 
        content.classList.remove('scale-100','opacity-100'); 
        content.classList.add('scale-95','opacity-0'); 
        modal.classList.remove('opacity-100'); 
        setTimeout(()=> modal.classList.add('hidden'), 200); 
    }

    // Abertura do Modal de Tarefa
    async function openTaskModal(mode = 'add', taskId = null){
        modalErrorMessage.textContent = '';
        taskForm.reset();
        taskPriorityInput.value = headerPrioritySelect.value;
        saveTaskBtn.disabled = false;
        saveTaskBtn.textContent = "Salvar Ordem";

        if (mode === 'add') {
            modalTitle.textContent = 'Adicionar Nova Ordem de Serviço';
            taskIdHidden.value = '';
            taskIdInput.value = `OS-${Math.floor(10000 + Math.random() * 90000)}`;
            taskIdInput.classList.remove('hidden');
            taskIdInput.disabled = false;
            taskIdDisplay.classList.add('hidden');
        } else if (mode === 'edit' && taskId) {
            // No modo de edição, buscamos os dados direto do Firebase
            // para garantir que estão atualizados
            try {
                const doc = await dbTasksRef.doc(taskId).get();
                if (!doc.exists) {
                    alert("Erro: Tarefa não encontrada.");
                    return;
                }
                const task = doc.data();

                modalTitle.textContent = 'Editar Ordem de Serviço';
                taskIdHidden.value = taskId; // O ID para salvar
                taskIdInput.classList.add('hidden');
                taskIdInput.disabled = true;
                taskIdDisplay.textContent = `OS: ${task.id}`; // O ID visível
                taskIdDisplay.classList.remove('hidden');
                taskTextInput.value = task.text;
                taskPriorityInput.value = task.priority || 'medium';

            } catch(err) {
                alert("Erro ao carregar tarefa: " + err.message);
                return;
            }
        }
        
        showModal(taskModal, taskModalContent);
        setTimeout(()=> taskTextInput.focus(), 150);
    }

    function closeTaskModal(){ 
        hideModal(taskModal, taskModalContent); 
    }

    function showDeleteModal(id){ 
        taskToDeleteId = id; 
        confirmDeleteBtn.disabled = false;
        showModal(deleteModal, deleteModalContent); 
    }

    function hideDeleteModal(){ 
        hideModal(deleteModal, deleteModalContent); 
        taskToDeleteId = null; 
    }

    // Gerador de Classes de Prioridade
    function getPriorityClasses(priority){
        if (priority === 'high') return { border:'border-red-500', text:'Alta', bg:'bg-red-500' };
        if (priority === 'medium') return { border:'border-orange-500', text:'Média', bg:'bg-orange-500' };
        return { border:'border-blue-500', text:'Baixa', bg:'bg-blue-500' };
    }

    // Criação do Elemento Card
    function createTaskElement(task){
        const p = getPriorityClasses(task.priority);
        // Sanitização é boa prática, embora o Firebase já nos proteja de injeção
        const idSan = DOMPurify.sanitize(task.id);
        const textSan = DOMPurify.sanitize(task.text);
        
        const card = document.createElement('div');
        card.className = `task-card bg-white p-4 rounded-lg shadow-md border-l-4 ${p.border} cursor-move group relative`;
        card.dataset.taskId = task.id; // ID real da OS (usado para DB)
        
        card.innerHTML = `
            <p class="text-sm font-semibold text-gray-500">${idSan}</p>
            <p class="text-gray-800 mt-1.5 font-medium task-text">${textSan}</p>
            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${p.bg} text-white">${p.text}</span>
            </div>
            <button class="delete-task-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" aria-label="Encerrar OS">✕</button>
        `;
        
        // O evento de clique AGORA abre o modal de edição
        card.addEventListener('click', () => openTaskModal('edit', task.id));
        
        // O evento do botão de excluir
        card.querySelector('.delete-task-btn').addEventListener('click', (e)=>{ 
            e.stopPropagation(); // Impede que o clique abra o modal de edição
            showDeleteModal(task.id); 
        });
        
        return card;
    }

    // --- 7. EVENT LISTENERS PRINCIPAIS (Modais e Botões) ---

    // Evento de Envio do Formulário (MODIFICADO PARA FIREBASE)
    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        modalErrorMessage.textContent = '';
        saveTaskBtn.disabled = true;
        saveTaskBtn.textContent = "Salvando...";

        const text = taskTextInput.value.trim();
        const priority = taskPriorityInput.value;
        const editingId = taskIdHidden.value; // ID do doc (se estiver editando)

        if (!text) { 
            modalErrorMessage.textContent = 'A descrição é obrigatória.'; 
            saveTaskBtn.disabled = false;
            saveTaskBtn.textContent = "Salvar Ordem";
            return; 
        }

        try {
            if (editingId) {
                // --- MODO EDIÇÃO (UPDATE) ---
                const docRef = dbTasksRef.doc(editingId);
                await docRef.update({
                    text: text,
                    priority: priority
                });
            } else {
                // --- MODO ADIÇÃO (SET/CREATE) ---
                const id = taskIdInput.value.trim(); // ID da OS (customizado)
                if (!id) { 
                    modalErrorMessage.textContent = 'Nº da OS/SM é obrigatório.'; 
                    saveTaskBtn.disabled = false;
                    saveTaskBtn.textContent = "Salvar Ordem";
                    return; 
                }

                const newTask = {
                    id: id,
                    text: text,
                    priority: priority,
                    column: 'col-restaurar' // Sempre começa na primeira coluna
                };
                
                // Verifica se o ID (OS) já existe
                const existingDoc = await dbTasksRef.doc(id).get();
                if (existingDoc.exists) {
                    modalErrorMessage.textContent = 'Este número de OS/SM já existe.';
                    saveTaskBtn.disabled = false;
                    saveTaskBtn.textContent = "Salvar Ordem";
                    return;
                }

                // Usa .doc(id).set() para usar nosso ID customizado
                await dbTasksRef.doc(id).set(newTask);
            }
            
            closeTaskModal();
            // Não precisa renderizar, o onSnapshot faz isso!

        } catch (err) {
             modalErrorMessage.textContent = 'Erro ao salvar: ' + err.message;
             saveTaskBtn.disabled = false;
             saveTaskBtn.textContent = "Salvar Ordem";
        }
    });

    // Evento de Exclusão (MODIFICADO PARA FIREBASE)
    confirmDeleteBtn.addEventListener('click', async () => {
        if (taskToDeleteId) {
            confirmDeleteBtn.disabled = true;
            try {
                await dbTasksRef.doc(taskToDeleteId).delete();
                hideDeleteModal();
                // Não precisa renderizar, o onSnapshot faz isso!
            } catch (err) {
                alert("Erro ao excluir: " + err.message);
                confirmDeleteBtn.disabled = false;
            }
        }
    });

    // Listeners de fechar modais
    cancelDeleteBtn.addEventListener('click', hideDeleteModal);
    closeModalBtn.addEventListener('click', closeTaskModal);
    cancelModalBtn.addEventListener('click', closeTaskModal);
    taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeTaskModal(); });
    deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) hideDeleteModal(); });
    addTaskBtn.addEventListener('click', () => openTaskModal('add'));

    // --- 8. INICIALIZAÇÃO DO DRAG & DROP (Sortable.js) ---

    function initSortable(){
        columnIds.forEach(colId => {
            new Sortable(columns[colId], {
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                
                // Evento ao soltar o card (MODIFICADO PARA FIREBASE)
                onEnd: (evt) => {
                    const taskId = evt.item.dataset.taskId;
                    const newCol = evt.to.dataset.columnId;
                    const oldCol = evt.from.dataset.columnId;

                    if (newCol === oldCol) return; // Não faz nada se for a mesma coluna
                    
                    // Atualiza apenas a coluna no banco de dados
                    dbTasksRef.doc(taskId).update({
                        column: newCol
                    })
                    .catch(err => {
                        alert("Erro ao mover card. Revertendo.");
                        // Reverte o movimento visualmente (opcional, mas bom)
                        evt.from.appendChild(evt.item);
                    });
                    
                    // Atualiza contadores locais imediatamente
                    updateAllCounts();
                }
            });
        });
    }

    // --- 9. EXECUÇÃO INICIAL ---
    // A inicialização agora é controlada pelo onAuthStateChanged (seção 4)
});
</script>
</body>
</html>